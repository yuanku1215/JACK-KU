<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio Mock — Location × Routing (Two Panels)</title>
  <style>
    /* =========================
       Design tokens (可當你的美編總控)
    ========================== */
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,.06);
      --panel-2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius-sm: 12px;
      --pad: 18px;
      --pad-lg: 22px;
      --maxw: 1080px;

      /* “少量顏色”只做語意區分 */
      --accent: #7dd3fc;     /* UI 強調 */
      --good: #86efac;       /* coverage / selected */
      --warn: #fde68a;       /* OD endpoints */
      --hot:  #fca5a5;       /* risk / alert */
      --purple:#c4b5fd;      /* routing lines */
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -20%, rgba(125,211,252,.25), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(196,181,253,.18), transparent 55%),
        radial-gradient(900px 700px at 60% 110%, rgba(134,239,172,.16), transparent 60%),
        var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    a{ color: var(--text); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 26px 18px 54px;
    }

    /* =========================
       Top nav
    ========================== */
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 10px 4px 22px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(125,211,252,.12);
    }
    .navlinks{
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
      color: var(--muted);
      font-size: 14px;
    }
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      cursor:pointer;
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }

    /* =========================
       Hero
    ========================== */
    .hero{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      align-items: stretch;
      margin-bottom: 14px;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad-lg);
      backdrop-filter: blur(10px);
    }
    .hero h1{
      margin: 0 0 10px;
      font-size: 24px;
      letter-spacing: .2px;
      line-height: 1.25;
    }
    .hero p{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14.5px;
    }
    .pillrow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .pill{
      display:inline-flex; align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12.5px;
      user-select:none;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
    }
    .stat .k{
      color: var(--muted2);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .stat .v{
      font-weight: 800;
      font-size: 16px;
      letter-spacing: .2px;
    }

    /* =========================
       Controls
    ========================== */
    .controls{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin: 14px 0 12px;
    }
    .controls .left{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .field{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 13px;
    }
    select, input[type="range"]{
      accent-color: var(--accent);
    }
    select{
      background: transparent;
      color: var(--text);
      border: none;
      outline: none;
      font-weight: 700;
      font-size: 13px;
    }
    option{ color:#0b1020; }
    .rangeWrap{
      display:flex; align-items:center; gap:10px;
      min-width: 320px;
      padding-right: 14px;
    }
    .rangeWrap input{ width: 160px; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      padding: 2px 8px;
      border-radius: 999px;
    }

    /* =========================
       Panels
    ========================== */
    .panels{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 8px;
    }
    .panelHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .panelTitle{
      font-weight: 900;
      letter-spacing: .2px;
      margin:0;
      font-size: 15px;
    }
    .panelSub{
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      user-select:none;
    }

    .viz{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      overflow:hidden;
      position:relative;
      height: 330px;
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12.5px;
    }
    .key{
      display:flex; align-items:center; gap:7px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 6px 10px;
      border-radius: 999px;
    }
    .sw{
      width: 10px; height: 10px; border-radius: 50%;
      border: 1px solid rgba(255,255,255,.18);
    }

    /* =========================
       Tooltip
    ========================== */
    .tip{
      position: fixed;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .12s ease, transform .12s ease;
      max-width: 260px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,14,30,.72);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      color: var(--text);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .tip .t1{ font-weight: 800; margin-bottom: 4px; }
    .tip .t2{ color: var(--muted); }

    /* =========================
       SVG styles (可微調美感)
    ========================== */
    svg{ width:100%; height:100%; display:block; }
    .edge{
      stroke: rgba(255,255,255,.18);
      stroke-width: 2;
      fill: none;
      transition: stroke .15s ease, stroke-width .15s ease, opacity .15s ease;
    }
    .edge.dim{ opacity: .22; }
    .edge.hot{ stroke: rgba(252,165,165,.55); }
    .edge.cool{ stroke: rgba(125,211,252,.55); }

    .route{
      stroke: rgba(196,181,253,.95);
      stroke-width: 4.2;
      fill: none;
      filter: drop-shadow(0 6px 18px rgba(196,181,253,.22));
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .route.secondary{
      stroke: rgba(125,211,252,.85);
      stroke-width: 3.4;
      filter: drop-shadow(0 6px 18px rgba(125,211,252,.16));
    }

    .coverage{
      fill: rgba(134,239,172,.12);
      stroke: rgba(134,239,172,.28);
      stroke-width: 1;
      transition: opacity .18s ease;
    }

    .node{
      cursor: pointer;
      transition: transform .12s ease, opacity .12s ease;
      transform-origin: center;
    }
    .node:hover{ transform: scale(1.08); }
    .node:focus{ outline: none; }
    .nodeCircle{
      stroke: rgba(255,255,255,.22);
      stroke-width: 1.2;
    }

    .node.demand .nodeCircle{ fill: rgba(255,255,255,.18); }
    .node.candidate .nodeCircle{ fill: rgba(125,211,252,.28); }
    .node.facility .nodeCircle{ fill: rgba(134,239,172,.82); stroke: rgba(255,255,255,.25); }
    .node.od .nodeCircle{ fill: rgba(253,230,138,.84); }

    .node.selected .nodeCircle{
      fill: rgba(134,239,172,.95);
      filter: drop-shadow(0 10px 24px rgba(134,239,172,.22));
    }

    /* Path-draw animation */
    .draw{
      stroke-dasharray: 1000;
      stroke-dashoffset: 1000;
      animation: draw 650ms ease forwards;
    }
    @keyframes draw{
      to{ stroke-dashoffset: 0; }
    }

    /* Panel update hint */
    .flash{
      animation: flash .35s ease;
    }
    @keyframes flash{
      0%{ background: rgba(255,255,255,.06); }
      50%{ background: rgba(255,255,255,.10); }
      100%{ background: rgba(255,255,255,.06); }
    }

    /* =========================
       Footer note
    ========================== */
    .note{
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12.5px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .note code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }

    @media (max-width: 920px){
      .hero{ grid-template-columns: 1fr; }
      .panels{ grid-template-columns: 1fr; }
      .rangeWrap{ min-width: 260px; }
      .viz{ height: 320px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">
        <span class="dot"></span>
        <span>Location × Routing</span>
        <span class="kbd">Mock v1</span>
      </div>
      <div class="navlinks">
        <a href="#panels">Routing</a>
        <a href="#panels">Location</a>
        <a href="#projects">Projects</a>
        <button class="btn" type="button" onclick="alert('這裡通常放：CV.pdf 或 /assets/pdf/CV.pdf')">CV PDF</button>
      </div>
    </div>

    <div class="hero">
      <div class="card">
        <h1>用「選址」與「路線規劃」當作品集入口：左看設施配置，右看路徑策略</h1>
        <p>
          這是一個一頁式的 Two Panels 原型：上方切換情境/目標/設施數量，
          兩個視窗同步更新；點選左側設施（hub）會影響右側路線展示。
          （你之後可以把這裡替換成真專案資料與圖。）
        </p>
        <div class="pillrow">
          <span class="pill">Multi-objective（Distance / Risk / Score）</span>
          <span class="pill">k-facility selection</span>
          <span class="pill">Hub-based routing demo</span>
          <span class="pill">SVG + Vanilla JS（GitHub Pages）</span>
        </div>
      </div>

      <div class="card">
        <div class="stats">
          <div class="stat">
            <div class="k">Scenario</div>
            <div class="v" id="statScenario">baseline</div>
          </div>
          <div class="stat">
            <div class="k">Objective</div>
            <div class="v" id="statObj">distance</div>
          </div>
          <div class="stat">
            <div class="k">k facilities</div>
            <div class="v" id="statK">5</div>
          </div>
          <div class="stat">
            <div class="k">Selected hub</div>
            <div class="v" id="statHub">F2</div>
          </div>
        </div>

        <div class="note" style="margin-top:12px;">
          <span>小技巧：</span>
          <code>點左圖的綠色設施點</code>
          <span>→ 右圖路徑會換 hub。</span>
        </div>
      </div>
    </div>

    <div class="controls card">
      <div class="left">
        <div class="field">
          <span>Scenario</span>
          <select id="scenarioSel">
            <option value="baseline">baseline</option>
            <option value="peak">peak</option>
            <option value="rainy">rainy</option>
          </select>
        </div>

        <div class="field">
          <span>Objective</span>
          <select id="objSel">
            <option value="distance">distance</option>
            <option value="risk">risk</option>
            <option value="score">score</option>
          </select>
        </div>

        <div class="field rangeWrap">
          <span>k</span>
          <input id="kRange" type="range" min="3" max="8" step="1" value="5" />
          <span class="kbd" id="kLabel">5</span>
          <span style="opacity:.75;">facilities</span>
        </div>
      </div>

      <div class="badge" id="hintBadge">
        點左側設施點切換 hub｜Hover 路段看權重
      </div>
    </div>

    <div id="panels" class="panels">
      <!-- LEFT: Location -->
      <div class="card">
        <div class="panelHead">
          <div>
            <p class="panelTitle">Facility Location</p>
            <p class="panelSub">候選點 → 選中設施（k）＋ coverage 視覺化（示意）</p>
          </div>
          <div class="badge" id="locBadge">Selected: <b id="locBadgeText">F2, F4, F6, F7, F8</b></div>
        </div>

        <div class="viz" id="locViz" aria-label="Facility location visualization">
          <svg id="locSvg" viewBox="0 0 640 360" role="img" aria-label="Location panel SVG"></svg>
        </div>

        <div class="legend">
          <div class="key"><span class="sw" style="background:rgba(125,211,252,.35)"></span>Candidate</div>
          <div class="key"><span class="sw" style="background:rgba(134,239,172,.85)"></span>Facility (selected)</div>
          <div class="key"><span class="sw" style="background:rgba(255,255,255,.18)"></span>Demand node</div>
        </div>
      </div>

      <!-- RIGHT: Routing -->
      <div class="card">
        <div class="panelHead">
          <div>
            <p class="panelTitle">Routing</p>
            <p class="panelSub">OD paths（示意）＋ hub-based route（受左側 hub 影響）</p>
          </div>
          <div class="badge">Hub: <b id="hubBadge">F2</b></div>
        </div>

        <div class="viz" id="rtViz" aria-label="Routing visualization">
          <svg id="rtSvg" viewBox="0 0 640 360" role="img" aria-label="Routing panel SVG"></svg>
        </div>

        <div class="legend">
          <div class="key"><span class="sw" style="background:rgba(196,181,253,.95)"></span>Main route</div>
          <div class="key"><span class="sw" style="background:rgba(125,211,252,.85)"></span>Secondary</div>
          <div class="key"><span class="sw" style="background:rgba(253,230,138,.85)"></span>OD endpoints</div>
        </div>
      </div>
    </div>

    <div id="projects" class="card" style="margin-top:14px;">
      <p class="panelTitle">Quick Links（示意區）</p>
      <p class="panelSub">
        這裡通常放 3–4 個 Featured Projects 卡片（點進去各自的 detail page）。
      </p>
      <div class="pillrow" style="margin-top:10px;">
        <button class="btn" type="button" onclick="alert('示意：/pages/project/levee.html')">Levee Crossing Optimization</button>
        <button class="btn" type="button" onclick="alert('示意：/pages/project/sqa-workshop.html')">SQA Workshop & Demos</button>
        <button class="btn" type="button" onclick="alert('示意：/pages/project/photogrammetry.html')">UAV Photogrammetry</button>
      </div>
      <div class="note">
        <span>部署提示：</span>
        <code>GitHub Pages</code>
        <span>可直接用這種純前端結構，未來再把 JSON 換成你的真資料即可。</span>
      </div>
    </div>
  </div>

  <div class="tip" id="tip" role="tooltip" aria-hidden="true">
    <div class="t1" id="tipT1"></div>
    <div class="t2" id="tipT2"></div>
  </div>

<script>
/* =========================================================
   Mock data（你未來可改成 /data/*.json）
========================================================= */
const DATA = {
  nodes: [
    // demand nodes
    { id:"D1", x:110, y:90,  type:"demand" },
    { id:"D2", x:160, y:250, type:"demand" },
    { id:"D3", x:260, y:140, type:"demand" },
    { id:"D4", x:420, y:110, type:"demand" },
    { id:"D5", x:500, y:240, type:"demand" },
    { id:"D6", x:570, y:130, type:"demand" },

    // candidate facility nodes (F1..F8)
    { id:"F1", x:120, y:170, type:"candidate" },
    { id:"F2", x:210, y:90,  type:"candidate" },
    { id:"F3", x:240, y:260, type:"candidate" },
    { id:"F4", x:320, y:170, type:"candidate" },
    { id:"F5", x:380, y:260, type:"candidate" },
    { id:"F6", x:450, y:80,  type:"candidate" },
    { id:"F7", x:520, y:170, type:"candidate" },
    { id:"F8", x:560, y:250, type:"candidate" },

    // OD endpoints (for routing panel)
    { id:"A", x:90,  y:300, type:"od" },
    { id:"B", x:600, y:60,  type:"od" }
  ],
  // A simple base edge list for visuals + tooltip weights
  edges: [
    ["A","D2"],["D2","F1"],["F1","D1"],["D1","F2"],["F2","D3"],["D3","F4"],["F4","D4"],["D4","F6"],["F6","B"],
    ["D2","F3"],["F3","D3"],["F3","F4"],["F4","F5"],["F5","D5"],["D5","F8"],["F8","B"],
    ["D4","F7"],["F7","D6"],["D6","B"],["D5","F7"],["F7","F8"],["F2","F4"],["F4","F6"],["F6","F7"]
  ].map(([u,v], i) => ({
    u, v,
    w: {
      distance: 1 + (i % 6) * 0.7,
      risk:     1 + ((i*3) % 7) * 0.6,
      score:    1 + ((i*5) % 5) * 0.8
    }
  })),
  // facility selection sets by scenario & k (mock)
  facilitySets: {
    baseline: {
      3: ["F2","F4","F7"],
      4: ["F2","F4","F6","F7"],
      5: ["F2","F4","F6","F7","F8"],
      6: ["F1","F2","F4","F6","F7","F8"],
      7: ["F1","F2","F3","F4","F6","F7","F8"],
      8: ["F1","F2","F3","F4","F5","F6","F7","F8"]
    },
    peak: {
      3: ["F1","F4","F8"],
      4: ["F1","F4","F7","F8"],
      5: ["F1","F3","F4","F7","F8"],
      6: ["F1","F3","F4","F5","F7","F8"],
      7: ["F1","F2","F3","F4","F5","F7","F8"],
      8: ["F1","F2","F3","F4","F5","F6","F7","F8"]
    },
    rainy: {
      3: ["F2","F5","F8"],
      4: ["F2","F4","F5","F8"],
      5: ["F2","F4","F5","F7","F8"],
      6: ["F1","F2","F4","F5","F7","F8"],
      7: ["F1","F2","F3","F4","F5","F7","F8"],
      8: ["F1","F2","F3","F4","F5","F6","F7","F8"]
    }
  },
  // route templates by objective (mock)
  routes: {
    distance: {
      main: ["A","D2","F1","D1","F2","D3","F4","D4","F6","B"],
      secondary: ["A","D2","F3","D3","F4","F6","B"]
    },
    risk: {
      main: ["A","D2","F3","D3","F4","D4","F7","D6","B"],
      secondary: ["A","D2","F1","D1","F2","F4","F6","B"]
    },
    score: {
      main: ["A","D2","F3","F4","F5","D5","F8","B"],
      secondary: ["A","D2","F1","D1","F2","D3","F4","F5","D5","F7","D6","B"]
    }
  },
  // hub-based routing (mock): given hub, connect A->hub and hub->B via templates
  hubRoutes: {
    distance: {
      F1: ["A","D2","F1","D1","F2","D3","F4","F6","B"],
      F2: ["A","D2","F1","D1","F2","D3","F4","F6","B"],
      F3: ["A","D2","F3","D3","F4","F6","B"],
      F4: ["A","D2","F3","F4","F6","B"],
      F5: ["A","D2","F3","F4","F5","D5","F8","B"],
      F6: ["A","D2","F1","D1","F2","F4","F6","B"],
      F7: ["A","D2","F3","D3","F4","D4","F7","D6","B"],
      F8: ["A","D2","F3","F4","F5","D5","F8","B"]
    },
    risk: {
      F1: ["A","D2","F3","D3","F4","D4","F7","D6","B"],
      F2: ["A","D2","F1","D1","F2","F4","F6","B"],
      F3: ["A","D2","F3","D3","F4","D4","F7","D6","B"],
      F4: ["A","D2","F3","F4","D4","F7","D6","B"],
      F5: ["A","D2","F3","F4","F5","D5","F7","D6","B"],
      F6: ["A","D2","F1","D1","F2","F4","F6","B"],
      F7: ["A","D2","F3","D3","F4","D4","F7","D6","B"],
      F8: ["A","D2","F3","F4","F5","D5","F8","B"]
    },
    score: {
      F1: ["A","D2","F1","D1","F2","D3","F4","F5","D5","F8","B"],
      F2: ["A","D2","F1","D1","F2","D3","F4","F5","D5","F8","B"],
      F3: ["A","D2","F3","F4","F5","D5","F8","B"],
      F4: ["A","D2","F3","F4","F5","D5","F8","B"],
      F5: ["A","D2","F3","F4","F5","D5","F8","B"],
      F6: ["A","D2","F1","D1","F2","F4","F6","F7","D6","B"],
      F7: ["A","D2","F3","F4","F5","D5","F7","D6","B"],
      F8: ["A","D2","F3","F4","F5","D5","F8","B"]
    }
  }
};

/* =========================================================
   State
========================================================= */
const state = {
  scenario: "baseline",
  objective: "distance",
  k: 5,
  selectedHub: "F2",
  coverageR: 48
};

/* =========================================================
   Helpers
========================================================= */
const $ = (sel) => document.querySelector(sel);
const tip = $("#tip");
const tipT1 = $("#tipT1");
const tipT2 = $("#tipT2");

function nodeById(id){ return DATA.nodes.find(n => n.id === id); }
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function setTip(x, y, title, desc){
  tipT1.textContent = title;
  tipT2.textContent = desc;
  tip.style.left = (x + 12) + "px";
  tip.style.top  = (y + 12) + "px";
  tip.style.opacity = "1";
  tip.style.transform = "translateY(0)";
  tip.setAttribute("aria-hidden", "false");
}
function hideTip(){
  tip.style.opacity = "0";
  tip.style.transform = "translateY(8px)";
  tip.setAttribute("aria-hidden", "true");
}

function flash(el){
  el.classList.remove("flash");
  // force reflow
  void el.offsetWidth;
  el.classList.add("flash");
}

/* =========================================================
   SVG builders
========================================================= */
function svgEl(tag, attrs={}){
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}

function drawBaseNetwork(svg, {dimEdges=false, highlightObjective=null}={}){
  // clear
  svg.innerHTML = "";

  // background subtle grid
  const bg = svgEl("g", { opacity: "0.55" });
  for (let x=40; x<=640; x+=80){
    bg.appendChild(svgEl("line", { x1:x, y1:0, x2:x, y2:360, stroke:"rgba(255,255,255,.06)" }));
  }
  for (let y=40; y<=360; y+=80){
    bg.appendChild(svgEl("line", { x1:0, y1:y, x2:640, y2:y, stroke:"rgba(255,255,255,.06)" }));
  }
  svg.appendChild(bg);

  // edges layer
  const gEdges = svgEl("g", { id:"edges" });
  for (const e of DATA.edges){
    const a = nodeById(e.u), b = nodeById(e.v);
    const w = e.w[state.objective];
    const baseW = 1.7 + clamp(w/4.5, 0, 1.2); // thickness hint

    const line = svgEl("path", {
      d: `M ${a.x} ${a.y} L ${b.x} ${b.y}`,
      class: `edge ${dimEdges ? "dim" : ""} ${highlightObjective === "risk" ? "hot" : (highlightObjective ? "cool" : "")}`,
      "stroke-width": baseW.toFixed(2)
    });

    line.addEventListener("mousemove", (ev) => {
      const title = `Edge ${e.u} → ${e.v}`;
      const desc  = `${state.objective}: ${e.w[state.objective].toFixed(2)}（示意）`;
      setTip(ev.clientX, ev.clientY, title, desc);
    });
    line.addEventListener("mouseleave", hideTip);

    gEdges.appendChild(line);
  }
  svg.appendChild(gEdges);

  return { gEdges };
}

function drawNodes(svg, {selectedFacilities=[], showOD=false, hubClickable=false}={}){
  const gNodes = svgEl("g", { id:"nodes" });

  for (const n of DATA.nodes){
    if (!showOD && n.type === "od") continue;

    // classify for styles
    let cls = "node";
    if (n.type === "demand") cls += " demand";
    if (n.type === "candidate") cls += " candidate";
    if (n.type === "od") cls += " od";

    const isFacility = selectedFacilities.includes(n.id);
    if (isFacility) cls += " facility";
    if (n.id === state.selectedHub && isFacility) cls += " selected";

    const g = svgEl("g", { class: cls, tabindex: (hubClickable && isFacility) ? "0" : "-1", "data-id": n.id });

    const r = (n.type === "od") ? 8.5 : (isFacility ? 7.3 : 6.2);
    const c = svgEl("circle", { cx:n.x, cy:n.y, r, class:"nodeCircle" });

    // label (very subtle)
    const label = svgEl("text", {
      x: n.x + 10, y: n.y + 4,
      fill: "rgba(255,255,255,.45)",
      "font-size": "11",
      "font-weight":"700",
      "font-family":"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace"
    });
    label.textContent = n.id;

    g.appendChild(c);
    g.appendChild(label);

    // tooltip
    g.addEventListener("mousemove", (ev) => {
      let title = n.id;
      let desc = "";
      if (n.type === "demand") desc = "Demand node（示意）";
      if (n.type === "candidate") desc = "Candidate facility（可選址）";
      if (n.type === "od") desc = "OD endpoint";
      if (isFacility) desc = (n.id === state.selectedHub) ? "Selected facility hub（點我可切換）" : "Selected facility（點我可切換 hub）";
      setTip(ev.clientX, ev.clientY, title, desc);
    });
    g.addEventListener("mouseleave", hideTip);

    // click to select hub
    if (hubClickable && isFacility){
      g.style.cursor = "pointer";
      const activate = () => {
        state.selectedHub = n.id;
        renderAll();
      };
      g.addEventListener("click", activate);
      g.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") activate();
      });
    }

    gNodes.appendChild(g);
  }

  svg.appendChild(gNodes);
  return { gNodes };
}

function drawCoverage(svg, selectedFacilities){
  const gCov = svgEl("g", { id:"coverage" });
  for (const fid of selectedFacilities){
    const n = nodeById(fid);
    const circle = svgEl("circle", {
      cx: n.x, cy: n.y, r: state.coverageR,
      class: "coverage"
    });
    gCov.appendChild(circle);
  }
  svg.appendChild(gCov);
  return { gCov };
}

function pathFromNodeList(list){
  const pts = list.map(id => nodeById(id));
  return pts.map((p,i) => (i===0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(" ");
}

function drawRoutes(svg, {mainList, secondaryList, addHubRouteList=null}){
  const gRoutes = svgEl("g", { id:"routes" });

  const main = svgEl("path", { d: pathFromNodeList(mainList), class:"route draw" });
  gRoutes.appendChild(main);

  if (secondaryList){
    const sec = svgEl("path", { d: pathFromNodeList(secondaryList), class:"route secondary draw" });
    gRoutes.appendChild(sec);
  }

  if (addHubRouteList){
    // as extra highlight, slightly different opacity
    const hubp = svgEl("path", {
      d: pathFromNodeList(addHubRouteList),
      class:"route draw",
      stroke: "rgba(134,239,172,.92)",
      "stroke-width":"4.4",
      opacity: ".9"
    });
    gRoutes.appendChild(hubp);
  }

  svg.appendChild(gRoutes);
  return { gRoutes };
}

/* =========================================================
   Renderers
========================================================= */
function renderLocation(){
  const svg = $("#locSvg");
  const selectedFacilities = DATA.facilitySets[state.scenario][state.k] || [];
  // Keep selectedHub valid
  if (!selectedFacilities.includes(state.selectedHub)){
    state.selectedHub = selectedFacilities[0] || "F2";
  }

  // base network (dim edges for location; we focus on coverage)
  drawBaseNetwork(svg, {dimEdges:true, highlightObjective: null});

  // coverage behind nodes
  drawCoverage(svg, selectedFacilities);

  // nodes on top, hub clickable
  drawNodes(svg, {selectedFacilities, showOD:false, hubClickable:true});

  // badge text
  $("#locBadgeText").textContent = selectedFacilities.join(", ");

  // update stats
  $("#statScenario").textContent = state.scenario;
  $("#statObj").textContent = state.objective;
  $("#statK").textContent = String(state.k);
  $("#statHub").textContent = state.selectedHub;

  flash($("#locViz"));
}

function renderRouting(){
  const svg = $("#rtSvg");

  // base network (not dim; we show objective hint)
  const highlight = (state.objective === "risk") ? "risk" : "cool";
  drawBaseNetwork(svg, {dimEdges:false, highlightObjective: highlight});

  // OD nodes + demand + candidates (show OD)
  // selected facilities still shown as green for context
  const selectedFacilities = DATA.facilitySets[state.scenario][state.k] || [];
  drawNodes(svg, {selectedFacilities, showOD:true, hubClickable:false});

  // main + secondary by objective
  const base = DATA.routes[state.objective];
  const hubRoute = (DATA.hubRoutes[state.objective][state.selectedHub]) || base.main;

  drawRoutes(svg, {
    mainList: base.main,
    secondaryList: base.secondary,
    addHubRouteList: hubRoute
  });

  $("#hubBadge").textContent = state.selectedHub;

  flash($("#rtViz"));
}

function renderAll(){
  renderLocation();
  renderRouting();
}

/* =========================================================
   Controls binding
========================================================= */
function bindControls(){
  const scenarioSel = $("#scenarioSel");
  const objSel = $("#objSel");
  const kRange = $("#kRange");
  const kLabel = $("#kLabel");

  scenarioSel.value = state.scenario;
  objSel.value = state.objective;
  kRange.value = state.k;
  kLabel.textContent = state.k;

  scenarioSel.addEventListener("change", () => {
    state.scenario = scenarioSel.value;
    renderAll();
  });

  objSel.addEventListener("change", () => {
    state.objective = objSel.value;
    renderAll();
  });

  kRange.addEventListener("input", () => {
    state.k = Number(kRange.value);
    kLabel.textContent = state.k;
    renderAll();
  });
}

/* =========================================================
   Init
========================================================= */
document.addEventListener("mousemove", (e) => {
  // keep tooltip inside viewport a bit
  const w = 280, h = 120;
  const x = (e.clientX + 12 > window.innerWidth - w) ? (e.clientX - w) : (e.clientX + 12);
  const y = (e.clientY + 12 > window.innerHeight - h) ? (e.clientY - h) : (e.clientY + 12);
  tip.style.left = x + "px";
  tip.style.top  = y + "px";
});
window.addEventListener("scroll", hideTip);

bindControls();
renderAll();
</script>
</body>
</html>
